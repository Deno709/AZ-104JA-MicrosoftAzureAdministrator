---
lab:
    title: '11 - 監視を実装する'
    module: 'モジュール 11 - 監視'
---

# ラボ 11 - モニタリングを実装する
# 受講者用ラボ マニュアル

## ラボ シナリオ

Azure のパフォーマンスと Azure の仮想マシンに特に焦点を当てた Azure リソースの構成に関する洞察を提供する Azure の機能を評価することになりました。これを実行するには、Log Analytics や Azure Monitor の機能を調べる必要があります。

## 目標

このラボでは、次の内容を学習します。

+ タスク 1: 課題環境をプロビジョニングする
+ タスク 2: Log Analytics ワークスペースと Azure Automation ベースのソリューションを作成および構成する
+ タスク 3: Azure Virtual Machines の既定の監視設定を確認する
+ タスク 4: Azure Virtual Machines の診断設定を構成する
+ タスク 5: Azure Monitor の機能をレビューする
+ タスク 6: Azure Log Analytics の機能をレビューする

## 予想時間: 45分間

## 指示

### エクササイズ 1

#### タスク 1: 課題環境をプロビジョニングする

このタスクでは、監視シナリオのテストに使用する仮想マシンをデプロイします。

1. [Azure portal](https://portal.azure.com) にログインします。

1. Azure portal で右上にあるアイコンをクリックして **Azure Cloud Shell** を開きます。

1. **Bash** または **PowerShell** のいずれかを選択するように求められた場合、**PowerShell** を選択します。 

    >**注**: **Cloud Shell** を初めて起動し、「**ストレージがマウントされていません**」というメッセージが表示されたら、このラボで使用しているサブスクリプションを選択し、「**ストレージの作成**」 をクリックします。 

1. Cloud Shell ペインのツール バーで **ファイルのアップロード/ダウンロード**アイコンをクリックし、ドロップダウン メニューで**アップロード** をクリックし、**\\Allfiles\\Labs\\11\\az104-11-vm-template.json** と **\\Allfiles\\Labs\\11\\az104-11-vm-parameters.json**をCloud Shell ホーム ディレクトリにアップロードします。

1. 「Cloud Shell」 ペインから次のコマンドを実行して、Virtual Machines をホストするリソース グループを作成します (`[Azure_region]` プレースホルダーを Azure Virtual Machines をデプロイする Azure リージョンの名前に置き換えます)。

    >**注**: 参照している[ワークスペース マッピング ドキュメント](https://docs.microsoft.com/ja-jp/azure/automation/how-to/region-mappings)内で **Log Analytics ワークスペース リージョン** としてリストされているリージョンのいずれかを必ず選択します。

   ```pwsh
   $location = '[Azure_region]'

   $rgName = 'az104-11-rg0'

   New-AzResourceGroup -Name $rgName -location $location
   ```

1. 「Cloud Shell」 ペインから、次のコマンドを実行して最初の仮想ネットワークを作成し、アップロードしたテンプレートとパラメーター ファイルを使用して仮想マシンをデプロイします。

   ```pwsh
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-11-vm-template.json `
      -TemplateParameterFile $HOME/az104-11-vm-parameters.json `
      -AsJob
   ```

    >**注**: デプロイが完了するのを待たずに、次のタスクに進みます。デプロイメント過程は約3分間かかります。

#### タスク 2: Microsoft.Insights および Microsoft.AlertsManagement リソース プロバイダーを登録します。

1. 「Cloud Shell」ペインから、次の操作を実行して、Microsoft.Insights および Microsoft.AlertsManagement リソース プロバイダーを登録します。

   ```pwsh
   Register-AzResourceProvider -ProviderNamespace Microsoft.Insights
   
   Register-AzResourceProvider -ProviderNamespace Microsoft.AlertsManagement
   ```
   
1. 「Cloud Shell」ペインを最小化します (閉じないでください)。

#### タスク 3: Log Analytics ワークスペースと Azure Automation ベースのソリューションを作成および構成する。

このタスクでは、Azure Log Analytics ワークスペースと Azure Automation ベースのソリューションを作成および構成します。

1. Azure portalで、 **Log Analytics ワークスペース**を検索して選択し、「**Log Analytics ワークスペース**」 ブレードで 「**+ 追加**」 をクリックします。

1. 「**Log Analytics ワークスペースの作成**」 ブレードの 「**基本**」 タブで、次の設定を行い、「**確認および作成**」 をクリックし、「**作成**」 をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | 新しいリソース グループを**az104-11-rg1** の名前で作成 |
    | Log Analytics ワークスペース | 一意な名前 |
    | 場所 | 前のタスクで仮想マシンをデプロイした Azure リージョンの名前 |

    >**注**: 前のタスクで仮想マシンをデプロイしたリージョンと同じリージョンを指定してください。

    >**注**: デプロイが完了するまで待ちます。デプロイメント過程は約 1 分間かかる場合があります。

1. Azure portal で、「**Automation アカウント**」 を検索して選択し、「**Automation アカウント**」 ブレードで 「**+ 追加**」 をクリックします。 

1. 「**Automation アカウントの追加**」 ブレードで次の設定を指定し、「**作成**」 をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | 一意な名前 |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | **az104-11-rg1** |
    | 場所 | [ワークスペース マッピングのドキュメント](https://docs.microsoft.com/ja-jp/azure/automation/how-to/region-mappings)に基づいて決定される Azure リージョンの名前 |
    | Azure 実行アカウントの作成 | **はい** |

    >**注**: [ワークスペース マッピングのドキュメント](https://docs.microsoft.com/ja-jp/azure/automation/how-to/region-mappings)に基づいて Azure リージョンを指定していることを確認します。

    >**注**: デプロイが完了するまで待ちます。デプロイには約 3 分間かかります。

1. 「**Automation アカウント**」 ブレードで 、「**更新**」 をクリックしてから、新しく作成した Automation アカウントを表すエントリをクリックします。   

1. Automation アカウントブレードの 「**構成管理**」 セクションで、「**インベントリ**」 をクリック します。

1. 「**インベントリ**」 ウィンドウの 「**Log Analytics ワークスペース**」 ドロップダウン リストで、このタスクで前に作成した 「Log Analytics ワークスペース」 を選択し、「**有効化**」 をクリック します。

    >**注**: 対応する Log Analytics ソリューションのインストールが完了するまで待ちます。これにはおよそ3 分かかる場合があります。

    >**注**: これにより、**更新プログラムの管理**ソリューションも自動的にインストールされます。

1. 「Automation アカウント」 ブレードの 「**更新プログラムの管理**」 セクションで、「**更新プログラムの管理**」 をクリックし、「**有効化**」 をクリックします。

    >**注**: インストールが完了するのを待ってください。これにはおよそ 5 分間かかる場合があります。

#### タスク 4: Azure 仮想マシンの既定の監視設定を確認する

このタスクでは、Azure 仮想マシンの既定の監視設定を確認します。

1. Azure portalで 「**Virtual Machines**」 を検索して選択し、「**Virtual Machines**」 ブレードで 「**az104-11-vm0**」 をクリックします。

1. 「**az104-11-vm0**」 ブレードの 「**監視**」 セクションで、「**メトリック**」 をクリックします。

1. 「**az104-11-vm0 | メトリック**」 ブレードの既定のグラフで、使用可能な **メトリック名前空間** は**仮想マシンホスト**のみです。 

    >**注**: ゲスト レベルの診断設定がまだ構成されていないので、これは予期されます。

1. 「**メトリック**」 ドロップダウン リストで、使用可能なメトリックの一覧を確認します。

    >**注**: このリストには、ゲストレベルの指標にアクセスしなくても、仮想マシン ホストから収集できる、CPU、ディスク、およびネットワーク関連の指標の範囲が含まれています。

1. **メトリック** ドロップダウン リストで「**Percentage CPU**」 を選択し、「**集計**」 ドロップダウン リストで 「**平均**」 を選択して、結果のグラフを確認します。 

#### タスク 5: Azure virtual machine の診断設定を構成する

このタスクでは、Azure 仮想マシンの診断設定を構成します。

1. 「**az104-11-vm0**」 ブレードの 「**監視**」 セクションで、「**診断設定**」 をクリック します。

1. 「**az104-11-vm0 | 診断設定**」 ブレードの 「**概要**」 タブで 、「**ゲスト レベルの監視を有効にする**」 をクリックします。

    >**注**: 操作が完了するまでお待ちください。これにはおよそ3 分かかる場合があります。

1. 「**az104-11-vm0 | 診断設定**」 ブレードの 「**パフォーマンス カウンター**」 タブに切り替え 、使用可能なカウンターを確認します。

    >**注**: 既定では、CPU、メモリ、ディスク、およびネットワークのカウンタが有効になっています。詳細な一覧については、「**カスタム**」 ビューに切り替えることができます。

1. 「**az104-11-vm0 | 診断設定**」 ブレードの 「**ログ**」 タブに切り替え、使用可能なイベント ログ収集オプションを確認します。

    >**注**: 既定では、ログ収集には、アプリケーション ログおよびシステム ログからの重大、エラー、および警告のエントリと、セキュリティ ログからの監査の失敗エントリが含まれます。ここでも、詳細な構成設定を行うために 「**カスタム**」 ビューに切り替えることができます。

1. **Az104-11-vm0** ブレードの**監視**セクションで、**ログ**をクリックして、**有効** をクリックします。  

1. 「**az104-11-vm0 - ログ**」 ブレードで、このラボで前に作成した 「Log Analytics ワークスペースの選択」 ドロップダウン リストで 「**先の手順で作成した Log Analytics ワークスペース**」 が選択されていることを確認し、「**有効**」 をクリック します。

    >**注**: 操作が完了するのを待たずに、代わりに次のタスクに進みます。操作には約 5 分間かかります。

1. 「**az104-11-vm0**」 ブレードの 「**監視**」 セクションで、「**メトリック**」 をクリック します。     

1. 「**az104-11-vm0 | メトリック**」 ブレードの既定のグラフで、現時点で、「**メトリック名前空間**」 ドロップダウン リストに、「**仮想マシン ホスト**」 エントリに加えて、「**ゲスト (クラシック)**」 エントリも含まれていることに注意してください。

    >**注**: これは、ゲスト レベルの診断設定を有効にしているためです。

1. 「**メトリック**」 ドロップダウン リストで、使用可能なメトリックの一覧を確認します。

    >**注**: このリストには、ホストレベルの監視のみに依存する場合は利用できない追加のゲストレベルの指標が含まれています。 

1. 「**メトリック**」 ドロップダウン リストで、「**\\Memory\\Available Bytes**」を選択し、「**集計**」ドロップダウン リストで「**平均**」 を選択して、結果のグラフを確認します。 

#### タスク 6: Azure Monitor の機能をレビューする

1. Azure portal で、「**モニター**」 を検索して選択し、「 **モニター | 概要**」 ブレードで 「**メトリック**」 をクリックします。

1. 「**範囲の選択**」 ブレードの 「**参照**」 タブで、**az104-11-rg0** リソース グループに移動し、それを展開して、そのリソース グループ内の **az104-11-vm0** 仮想マシンを選択し、「**適用**」 をクリック します。

    >**注**: これにより、 「**az104-11-vm0 | メトリック**」 ブレードで使用できるものと同じビューとオプションが提供されます。

1. **メトリック** ドロップダウン リストで「**Percentage CPU**」 を選択し、「**集計**」 ドロップダウン リストで 「**平均**」 を選択して、結果のグラフを確認します。 

1. 「**モニター | メトリック**」 ブレードで、「**新しいアラート ルール**」 をクリックします。

    >**注**: メトリックからの警告ルールの作成は、ゲスト (クラシック) メトリック名前空間からのメトリックではサポートされていません。これは、[Windows 仮想マシンの Resource Manager テンプレートを使用して Azure Monitor メトリック ストアにゲスト OS メトリックを送信する](https://docs.microsoft.com/ja-jp/azure/azure-monitor/platform/collect-custom-metrics-guestos-resource-manager-vm)のドキュメントで説明されているように、Azure リソース マネージャー テンプレートを使用して実現できます。

    
1. 「**アラート ルールの作成**」 ブレードの 「**条件**」 セクションで、「**percentage cpu の average が <ロジックが定義されていません> % 次の値より大きい 場合**」 をクリック します。 

1. 「**シグナル ロジックの構成**」 ブレードの「**アラート ロジック**」 セクションで次の設定を指定し (その他の箇所では既定値をそのまま使用します)、「**完了**」 をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | しきい値 | **Static** |
    | 演算子 | **次の値より大きい** |
    | 集計の種類 | **平均** |
    | しきい値 | **2** |
    | 集約粒度 (期間) | **5 分** |
    | 評価の頻度 | **1 分ごと** |

1. 「 **アラート ルールの作成** 」 ブレードの 「**アクション グループ**」 セクションで、「**アクション グループの選択**」 をクリックし、**＋アクション グループの作成** をクリックします。     

1. 「**アクション グループの作成**」 ブレードで、次の設定を指定します (その他の箇所では既定値をそのまま使用します)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソースグループ | **az104-11-rg1** |
    | アクション グループ名： | **az104-11-ag1** |
    | 表示名： | **az104-11-ag1** |


1. **[次へ: 通知>]** をクリックして「**アクション グループの作成**」 ブレードの 「**通知**」 セクションで、次の設定を指定します (その他の箇所では既定値をそのまま使用します)。

    | 設定 | 値 |
    | --- | --- |
    | 通知の種類 | **電子メール/SMS メッセージ/プッシュ/音声** |
    | 名前： | **az104-11-ag1 email** |


1. **az104-11-ag1 email**アクション行で、「**詳細の編集**」 （鉛筆のアイコン）をクリックします。

1. 「**電子メール/SMS メッセージ/プッシュ/音声**」 ブレードで、「**電子メール**」 チェックボックスをオンにし、「**電子メール**」 テキストボックスに自分のメールアドレスを入力し、他の設定は既定値のままで 「**OK**」をクリックし、「**アクション グループの作成**」 ブレードで 「**確認および作成**」をクリックして「**作成**」 をクリックします。

1. 「**アラート ルールの作成**」 ブレードに戻り、次の設定を指定します (その他の箇所では既定値をそのまま使用します)。

    | 設定 | 値 |
    | --- | --- |
    | アラート ルール名 | **Percentage CPUが テストしきい値を超える** |
    | 説明 | **Percentage CPUが テストしきい値を超える** |
    | 重要度 | **重大度 3** |
    | 作成時にアラート ルールを有効にする | **(選択します)** |

1. 「**アラート ルールの作成**」 をクリックし、「**アラート ルールの作成**」 ブレードを閉じます。

    >**注**: メトリック アラート ルールがアクティブになるには、最大 10 分間かかる場合があります。

1. Azure portalで 「**Virtual Machines**」 を検索して選択し、「**Virtual Machines**」 ブレードで 「**az104-11-vm0**」 をクリックします。

1. **az104-11-vm0** ブレード で、「**接続**」 をクリックし、ドロップダウン メニューで 「**RDP**」 をクリックし、「**RDP で接続する**」 ブレードで 「**RDP ファイルのダウンロード**」 をクリックします。ダウンロードした RDP ファイルを使用して、リモート デスクトップ セッションを開始します。

    >**注**: この手順は、Windows コンピューターからリモート デスクトップ経由で接続することを指します。Mac では、Mac App Store からリモート デスクトップ クライアントを使用でき、Linux コンピューターでは、オープンソースの RDP クライアント ソフトウェアを使用できます。

    >**注**: ターゲットの仮想マシンに接続する際は、警告メッセージを無視できます。

1. プロンプトが表示されたら、ユーザー名 "**Student**" とパスワード "**Pa55w.rd1234**" を使用してログインします。

1. リモート デスクトップ セッションで、「**スタート**」 ボタン（画面左下の Windows アイコン）をクリック し、「**Windows System**」 フォルダを展開して、「**Command Prompt**」 をクリックします。

1. コマンド プロンプトから次のコマンドを実行します。 

   ```
   for /l %a in (0,0,1) do echo a
   ```

    >**注**: これにより、新しく作成された警告ルールのしきい値を超える CPU 使用率を増加させる無限ループが開始されます。

1. リモート デスクトップ セッションを開いたままにして、ラボコンピューターの Azure portal を表示するブラウザー ウィンドウに戻ります。

1. Azure portalで、「**モニター**」 ブレードに移動し、「**アラート**」 をクリックします。

1. **Sev 3** 警告の数を記録し、**Sev 3** 行をクリックします。 

    >**注**: 数分待ってから 「**最新の情報に更新**」 をクリックする必要がある場合があります。 

1. 「**すべてのアラート**」ブレードで、生成されたアラートを確認します。

#### タスク 7: Azure Log Analytics の機能をレビューする

1. Azure portal で、「**モニター**」 ブレードに移動し、「**ログ**」 をクリックします。 

    >**注**: Log Analytics に初めてアクセスする場合は、「**はじめに**」 をクリックする必要があります。

1. 「**範囲の選択**」 ブレードで、**az104-11-rg0** リソース グループに移動し、それを展開して、「**a104-11-vm0**」 を選択して、「**適用**」 をクリック します。

1. クエリ ウインドウで、次のクエリを貼り付けて、「**実行**] をクリックします。

   ```
   // 仮想マシンの可用性メモリ
   // 過去 1 時間の VM の使用可能なメモリをグラフ化します。
   InsightsMetrics
   | where TimeGenerated > ago(1h)
   | where Name == "AvailableMB"
   | project TimeGenerated, Name, Val
   | render timechart
   ```

1. ツールバーの「**クエリの例**」をクリックし、「**クエリの例**」ペインで、「**Track VM availability (VM 可用性の追跡)**」を検索して「**実行**」をクリックします。

1. 結果のグラフを確認し、次のテキストを含む行を削除します。

   ```
   | where TimeGenerated > ago(1d)
   ```

    >**注**: ツールバーの 時間範囲 のエントリが 「**クエリに設定**」 から 「**過去 24 時間**」 に変更されました。 

1. クエリを再実行し、結果のグラフを確認します。

1. 「**新しいクエリ 1**」 タブの 「**テーブル**」 タブで、**Virtual machines** テーブルの一覧を確認します。

1. 「**仮想マシン**」セクションのテーブルの一覧で、**VMComputer** を探します。

    >**注**: いくつかのテーブルの名前は、このラボで先ほどインストールしたソリューションに対応しています。

1. **VMComputer** エントリの上にマウスを移動し、「**データのプレビュー**」 アイコン（目のマーク）をクリックします。     

1. データが使用可能な場合は、「**VMComputer**」 ウィンドウで 「**クエリエディターで表示**」 をクリックします。

    >**注**: 更新データが利用可能になるまで、数分待つ必要がある場合があります。

1. **Get started with sample queries** (サンプル クエリの使用を開始する) ペインで、ツールバーの **クエリの例** をクリックして、各タブを確認し、**Virtual machine free disk space** (仮想マシンの空きディスク領域)、**実行**の順にクリックします。

#### リソースのクリーンアップ

   >**注**: 新しく作成された Azure リソースのうち、使用しないリソースは必ず削除してください。使用していないリソースを削除することで、予期しないコストが発生しなくなります。

1. Azure portalの 「**Cloud Shell**」 ウインドウで、「**PowerShell**」 セッションを開始します。

1. 次のコマンドを実行して、このモジュールのラボ全体で作成されたすべてのリソース グループを一覧表示します。

   ```pwsh
   Get-AzResourceGroup -Name 'az104-11*'
   ```

1. 次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループを削除します。

   ```pwsh
   Get-AzResourceGroup -Name 'az104-11*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**注**: コマンドは非同期に実行されるため (-AsJob パラメーターによって決まります)、同じ PowerShell セッション内ですぐに別の PowerShell コマンドを実行できますが、リソース グループが実際に削除されるまでに数分かかります。

#### レビュー

このラボでは次の内容を学習しました。

- ラボ環境の構成
- Azure Log Analytics ワークスペースと Azure Automation ベースのソリューションの作成と構成
- Azure Virtual Machinesの既定の監視設定の確認
- Azure Virtual Machinesの診断設定の構成
- Azure Monitor の機能の確認
- Azure Log Analytics 機能の確認
