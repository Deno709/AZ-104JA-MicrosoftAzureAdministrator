---
lab:
    title: '05 - サイト間接続を実装する'
    module: 'モジュール 05 - サイト間接続'
---

# ラボ 05 - サイト間の接続性 を実装する
# 学生用ラボ マニュアル

## ラボ シナリオ

Contoso では、ボストン、ニューヨーク、シアトルの各オフィスを、メッシュ ワイドエリア ネットワーク リンクを介して接続しており、各オフィスの間に完全な接続性を備えています。Contoso のオンプレミス ネットワークのトポロジを反映したラボ環境を実装して、その機能を検証します。 

## 目標

このラボでは次の内容を学習します。

+ タスク 1: ラボ環境をプロビジョニングする
+ タスク 2: ローカルおよびグローバルバーチャル ネットワーク ピアリングを構成する
+ タスク 3: サイト間接続をテストする 

## 予想時間: 30 分

### 指示

#### タスク 1: ラボ環境をプロビジョニングする

このタスクでは、3 つの仮想マシンをそれぞれ別のバーチャル ネットワークにデプロイし、そのうちの 2 つを同じ Azure リージョンに配置し、3 つ目の仮想マシンを別の Azure リージョンにデプロイします。 

1. [Azure portal](https://portal.azure.com) にサインインします。

1. Azure portal の右上にあるアイコンをクリックして **Azure Cloud Shell** を開きます。

1. **Bash** や **PowerShell** のどちらかを選択するためのプロンプトが表示されたら、**PowerShell** を選択します。 

    > **注**: **Cloud Shell** の初回起動時に **「ストレージがマウントされていません」** というメッセージが表示された場合は、このラボで使用しているサブスクリプションを選択し、**「ストレージの作成」** を選択します。 

1. 「Cloud Shell」 ウィンドウのツールバーで **「ファイルのアップロード/ダウンロード」** アイコンをクリックし、ドロップダウン メニューで **「アップロード」** をクリックして、**\\Allfiles\\Labs\\05\\az104-05-vnetvm-template.json** ファイルと **\\Allfiles\\Labs\\05\\az104-05-vnetvm-parameters.json** ファイルを Cloud Shell のホーム ディレクトリにアップロードします。

1. 「Cloud Shell」 ウィンドウで次のコマンドを実行し、最初のバーチャル ネットワークと仮想マシンのペアをホストする最初のリソース グループを作成します (プレースホルダー `「Azure_region_1」` は、これらの Azure 仮想マシンをデプロイする Azure リージョンの名前に置き換えます)。

   ```pwsh
   $location = '[Azure_region_1]'

   $rgName = 'az104-05-rg0'

   New-AzResourceGroup -Name $rgName -Location $location
   ```
   > **注**: Azure リージョンを識別するには、Cloud Shell の PowerShell セッションから **(Get-AzLocation).Location** を実行します。
   
1. 「Cloud Shell」 ウィンドウで、次のコマンドを実行して最初の仮想ネットワークを作成し、アップロードしたテンプレートとパラメーター ファイルを使用して仮想マシンをデプロイします。

   ```pwsh
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-05-vnetvm-template.json `
      -TemplateParameterFile $HOME/az104-05-vnetvm-parameters.json `
      -nameSuffix 0 `
      -AsJob
   ```
1. 「Cloud Shell」 ウィンドウで、次のコマンドを実行して、2 番目のバーチャル ネットワークと 2 番目の仮想マシンをホストする 2 番目のリソース グループを作成します。

   ```pwsh
   $rgName = 'az104-05-rg1'

   New-AzResourceGroup -Name $rgName -Location $location
   ```
1. 「Cloud Shell」 ウィンドウで、次のコマンドを実行して 2 番目のバーチャル ネットワークを作成し、アップロードしたテンプレートとパラメーター ファイルを使用して仮想マシンをデプロイします。

   ```pwsh
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-05-vnetvm-template.json `
      -TemplateParameterFile $HOME/az104-05-vnetvm-parameters.json `
      -nameSuffix 1 `
      -AsJob
   ```
1. 「Cloud Shell」 ウィンドウで、次のコマンドを実行して、3 番目のバーチャル ネットワークと 3 番目の仮想マシンをホストする 3 番目のリソース グループを作成します (プレースホルダー `「Azure_region_2」` は、他の 2 つのデプロイで使用した Azure リージョンとは異なる Azure 仮想マシンをデプロイできる、別の Azure リージョンの名前に置き換えます)。

   ```pwsh
   $location = '[Azure_region_2]'

   $rgName = 'az104-05-rg2'

   New-AzResourceGroup -Name $rgName -Location $location
   ```
1. 「Cloud Shell」 ウィンドウで、次のコマンドを実行して 3 番目のバーチャル ネットワークを作成し、アップロードしたテンプレートとパラメーター ファイルを使用して仮想マシンをデプロイします。

   ```pwsh
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-05-vnetvm-template.json `
      -TemplateParameterFile $HOME/az104-05-vnetvm-parameters.json `
      -nameSuffix 2 `
      -AsJob
   ```
    > **注**: 次のタスクに進む前に、スクリプトが完了するのを待ちます。これにはおよそ 2 分かかります。

    > **注**: デプロイの状態を確認するには、このタスクで作成したリソース グループのプロパティを調べます。

1. 「Cloud Shell」 ウィンドウを閉じます。

#### タスク 2: ローカルおよびグローバルバーチャル ネットワーク ピアリングを構成する

このタスクでは、前のタスクでデプロイしたバーチャル ネットワーク間で、ローカル ピアリングとグローバル ピアリングを構成します。

1. Azure portal で、 **「バーチャル ネットワーク」** を検索して選択します。

1. 前のタスクで作成したバーチャル ネットワークを確認し、最初の 2 つが同じ Azure リージョンに配置され、3 番目が別の Azure リージョンに存在することを確認します。 

    > **注**: 3 つのバーチャル ネットワークのデプロイに使用したテンプレートに、3 つのバーチャル ネットワークの IP アドレス範囲が重複しないようにします。

1. バーチャル ネットワークのリストで、**「az104-05-vnet0」** をクリックします。

1. **「az104-05-vnet0** バーチャル ネットワーク」 ブレードの **「設定」** セクションで **「ピアリング」** をクリックしてから、**「+ 追加」** をクリックします。

1. 次の設定を指定し (他は既定値のままにします) **「追加」** をクリックします。

    | 設定 | 値|
    | --- | --- |
    | この仮想ネットワーク：ピアリング リンク名 | **az104-05-vnet0_to_az104-05-vnet1** |
    | この仮想ネットワーク：リモート仮想ネットワークへのトラフィック | **許可（規定）** |
    | この仮想ネットワーク：リモート仮想ネットワークから転送されるトラフィック | **この仮想ネットワークの外部から発信されるトラフィックをブロックする** |
    | 仮想ネットワーク ゲートウェイ | **None** |
    | リモート仮想ネットワーク：ピアリング リンク名 | **az104-05-vnet1_to_az104-05-vnet0** |    
    | バーチャル ネットワーク デプロイ モデル | **Resource Manager** |
    | リソース ID を知っている | 未選択 |
    | 定期売買 | このラボで使用する Azure サブスクリプションの名前 |
    | バーチャル ネットワーク | **az104-05-vnet1** |
    | リモート仮想ネットワークへのトラフィック | **許可（規定）** |
    | リモート仮想ネットワークから転送されるトラフィック | **この仮想ネットワークの外部から発信されるトラフィックをブロックする** |
    | 仮想ネットワーク ゲートウェイ | **None** |

    > **注**: この手順では、az104-05-vnet0 から az104-05-vnet1、az104-05-vnet1 から az104-05-vnet0 までの 2 つのローカル ピアリングを確立します。

1. **「az104-05-vnet0** バーチャル ネットワーク」 ブレードの **「設定」** セクションで **「ピアリング」** をクリックしてから、**「+ 追加」** をクリックします。

1. 次の設定でピアリングを追加します (他のユーザーには既定値を残します)。

    | 設定 | 値|
    | --- | --- |
    | この仮想ネットワーク：ピアリング リンク名 | **az104-05-vnet0_to_az104-05-vnet2** |
    | この仮想ネットワーク：リモート仮想ネットワークへのトラフィック | **許可（規定）** |
    | この仮想ネットワーク：リモート仮想ネットワークから転送されるトラフィック | **この仮想ネットワークの外部から発信されるトラフィックをブロックする** |
    | 仮想ネットワーク ゲートウェイ | **None** |
    | リモート仮想ネットワーク：ピアリング リンク名 | **az104-05-vnet2_to_az104-05-vnet0** |    
    | バーチャル ネットワーク デプロイ モデル | **Resource Manager** |
    | リソース ID を知っている | 未選択 |
    | 定期売買 | このラボで使用する Azure サブスクリプションの名前 |
    | バーチャル ネットワーク | **az104-05-vnet2** |
    | リモート仮想ネットワークへのトラフィック | **許可（規定）** |
    | リモート仮想ネットワークから転送されるトラフィック | **この仮想ネットワークの外部から発信されるトラフィックをブロックする** |
    | 仮想ネットワーク ゲートウェイ | **None** |
    
    > **注**: このステップでは、az104-05-vnet0 から az104-05-vnet2、az104-05-vnet2 から az104-05-vnet0 までの 2 つのグローバル ピアリングを確立します。

1. **「バーチャル ネットワーク」** ブレードに戻り、バーチャル ネットワークの一覧で **「az104-05-vnet1」** をクリックします。

1. **「az104-05-vnet1** バーチャル ネットワーク」 ブレードの **「設定」** セクションで **「ピアリング」** をクリックしてから、**「+ 追加」** をクリックします。

1. 次の設定でピアリングを追加します (他のユーザーには既定値を残します)。

    | 設定 | 値|
    | --- | --- |
    | この仮想ネットワーク：ピアリング リンク名 | **az104-05-vnet1_to_az104-05-vnet2** |
    | この仮想ネットワーク：リモート仮想ネットワークへのトラフィック | **許可（規定）** |
    | この仮想ネットワーク：リモート仮想ネットワークから転送されるトラフィック | **この仮想ネットワークの外部から発信されるトラフィックをブロックする** |
    | 仮想ネットワーク ゲートウェイ | **None** |
    | リモート仮想ネットワーク：ピアリング リンク名 | **az104-05-vnet2_to_az104-05-vnet1** |    
    | バーチャル ネットワーク デプロイ モデル | **Resource Manager** |
    | リソース ID を知っている | 未選択 |
    | 定期売買 | このラボで使用する Azure サブスクリプションの名前 |
    | バーチャル ネットワーク | **az104-05-vnet2** |
    | リモート仮想ネットワークへのトラフィック | **許可（規定）** |
    | リモート仮想ネットワークから転送されるトラフィック | **この仮想ネットワークの外部から発信されるトラフィックをブロックする** |
    | 仮想ネットワーク ゲートウェイ | **None** |
    
    > **注**: このステップでは、az104-05-vnet1 から az104-05-vnet2、az104-05-vnet2 から az104-05-vnet1 までの 2 つのグローバル ピアリングを確立します。

#### タスク 3: サイト間接続をテストする 

このタスクでは、前のタスクでローカル ピアリングとグローバル ピアリングを介して接続した 3 つのバーチャル ネットワーク上の仮想マシン間の接続性をテストします。

1. Azure portal で、**「仮想マシン」** を検索して選択します。

1. 仮想マシンのリストで、**「az104-05-vm0」** をクリックします。

1. **「az104-05-vm0」** ブレードで、**「接続」** をクリックし、ドロップダウン メニューで **「RDP」** をクリックし、**「RDP を使用して接続する」** ブレードで **「RDP ファイルのダウンロード」** をクリックし、プロンプトに従ってリモート デスクトップ セッションを開始します。

    > **注**: この手順では、Windows コンピューターからリモート デスクトップ経由で接続することを指します。Mac では、Mac App Store からリモート デスクトップ クライアントを使用でき、Linux コンピューターでは、オープンソースの RDP クライアント ソフトウェアを使用できます。

    > **注**: ターゲット仮想マシンに接続する際は、警告メッセージを無視できます。

1. プロンプトが表示されたら、**Student**のユーザー名と **Pa55w.rd1234** パスワードを使用してサインインします。

1. **az104-05-vm0** へのリモート デスクトップ セッション内で、**「スタート」** ボタンを右クリックし、右クリック メニューで **「Windows PowerShell (管理者)」** をクリックします。

1. Windows PowerShell コンソール ウィンドウで、次のコマンドを実行して、TCP ポート 3389 での **「az104-05-vm1」** (プライベート IP アドレスが **10.51.0.4** ) への接続性をテストします。

   ```pwsh
   Test-NetConnection -ComputerName 10.51.0.4 -Port 3389 -InformationLevel 'Detailed'
   ```
    > **注**: このテストで TCP 3389 を使用するのは、このポートがオペレーティング システムのファイアウォールによって既定で許可されているためです。 

1. コマンドの出力を調べて、接続が正常に行われたことを確認します。

1. Windows PowerShell コンソール ウィンドウで次のコマンドを実行して、**「az104-05-vm2」** (プライベート IP アドレスが **10.52.0.4**) への接続性をテストします。

   ```pwsh
   Test-NetConnection -ComputerName 10.52.0.4 -Port 3389 -InformationLevel 'Detailed'
   ```
1. ラボ コンピューターの Azure portal に戻り、**「仮想マシン」** ブレードに戻ります。 

1. 仮想マシンのリストで、**「az104-05-vm1」** をクリックします。

1. **「az104-05-vm1」** ブレードで、**「接続」** をクリックし、ドロップダウン メニューで **「RDP」** をクリックし、**「RDP を使用して接続する」** ブレードで **「RDP ファイルのダウンロード」** をクリックし、プロンプトに従ってリモート デスクトップ セッションを開始します。

    > **注**: この手順では、Windows コンピューターからリモート デスクトップ経由で接続することを指します。Mac では、Mac App Store からリモート デスクトップ クライアントを使用でき、Linux コンピューターでは、オープンソースの RDP クライアント ソフトウェアを使用できます。

    > **注**: ターゲット仮想マシンに接続する際は、警告メッセージを無視できます。

1. プロンプトが表示されたら、**Student**のユーザー名と **Pa55w.rd1234** パスワードを使用してサインインします。

1. **az104-05-vm1** へのリモート デスクトップ セッション内で、**「スタート」** ボタンを右クリックし、右クリック メニューで **「Windows PowerShell (管理者)」** をクリックします。

1. Windows PowerShell コンソール ウィンドウで、次のコマンドを実行して、TCP ポート 3389 での **「az104-05-vm2」** (プライベート IP アドレスが **10.52.0.4** ) への接続性をテストします。

   ```pwsh
   Test-NetConnection -ComputerName 10.52.0.4 -Port 3389 -InformationLevel 'Detailed'
   ```
    > **注**: このテストで TCP 3389 を使用するのは、このポートがオペレーティング システムのファイアウォールによって既定で許可されているためです。 

1. コマンドの出力を調べて、接続が正常に行われたことを確認します。

#### リソースをクリーン アップする

   > **注**: 新しく作成した Azure リソースのうち、使用しないリソースは必ず削除してください。使用しないリソースを削除しないと、予期しないコストが発生する場合があります。

1. Azure portal の **「Cloud Shell」** ウィンドウで **「PowerShell」** セッションを開きます。

1. 次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループのリストを表示します。

   ```pwsh
   Get-AzResourceGroup -Name 'az104-05*'
   ```

1. 次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループのリストを削除します。

   ```pwsh
   Get-AzResourceGroup -Name 'az104-05*' | Remove-AzResourceGroup -Force -AsJob
   ```

    > **注**: コマンドは非同期で実行されるので (-AsJob パラメーターによって決定されます)、別の PowerShell コマンドを同一 PowerShell セッション内ですぐに実行できますが、リソース グループが実際に削除されるまでに数分かかります。

#### レビュー

このラボでは次の内容を学習しました。

- ラボ環境をプロビジョニングしました
- ローカルバーチャル ネットワーク ピアリングおよびグローバルバーチャル ネットワーク ピアリングを構成しました。
- サイト間の接続性をテストしました 
