---
lab:
    title: '06 - トラフィック管理を実装する'
    module: 'モジュール 06 - ネットワーク トラフィック管理'
---

# ラボ 06 - トラフィック管理を実装する
# 受講者用ラボ マニュアル

## ラボ シナリオ

ハブおよびスポーク ネットワーク トポロジの Azure 仮想マシンを対象としたネットワーク トラフィックの管理テストを担当していましたが、Contoso は Azure 環境で実装を検討しています 前回のラボでテスト済みのメッシュ トポロジを作成しない方法。このテストでは、ハブを経由してトラフィックを強制的に流すユーザー定義ルートに依存してスポーク間の接続を実装する必要があり、また、レイヤ 4 およびレイヤ 7 ロード バランサーを使用して仮想マシン間でのトラフィック分散を行う必要があります。この目的のために、Azure Load Balancer (レイヤー 4) と Azure Application Gateway (レイヤー 7) を使用する予定です。

## 目標

このラボでは、次の内容を学習します。

+ タスク 1: ラボ環境をプロビジョニングする
+ タスク 2: ハブ スポーク ネットワーク トポロジを構成する
+ タスク 3: 仮想ネットワーク ピアリングの推移性をテストする
+ タスク 4: ハブとスポーク トポロジでルーティングを構成する
+ タスク 5: Azure Load Balancer を実装する
+ タスク 6: Azure Application Gateway を実装する

## 予想時間: 60分間

## 指示

### 演習 1

#### タスク 1: ラボ環境をプロビジョニングする

このタスクでは、同じ Azure リージョンに 4 つの仮想マシンをデプロイします。最初の 2 つはハブ仮想ネットワークに存在し、残りはそれぞれ別個のスポーク仮想ネットワークに存在します。

1. [Azure portal](https://portal.azure.com) にログインします。

1. Azure portal で右上にあるアイコンをクリックして **Azure Cloud Shell** を開きます。

1. **Bash** または **PowerShell** のいずれかを選択するように求められた場合、**PowerShell**を選択します。 

    >**注**: **Cloud Shell** を初めて起動し、「**ストレージがマウントされていません**」というメッセージが表示されたら、このラボで使用しているサブスクリプションを選択し、[**ストレージの作成**] をクリックします。 

1. Cloud Shell ペインのツールバーで、**ファイルのアップロード/ダウンロード** アイコンをクリックします。 ドロップダウン メニューで、 **アップロード**をクリックして、ファイル**\\Allfiles\\Module_06\\az104-06-vms-template.json**、**\\Allfiles\\Labs\\06\\az104-06-vm-template.json**、および **\\Allfiles\\Labs\\06\\az104-06-vm-parameters.json** を Cloud Shell ホームディレクトリにアップロードします。

1. [Cloud Shell] ペインから次を実行して、最初の Virtual Network と Virtual Machines のペアをホストする最初のリソース グループを作成します (`[Azure_region]` プレースホルダーを Azure Virtual Machines をデプロイする Azure リージョンの名前に置き換えます）。

   ```pwsh
   $location = '[Azure_region]'

   $rgName = 'az104-06-rg1'

   New-AzResourceGroup -Name $rgName -Location $location
   ```
1. [Cloud Shell] ペインで、次のコマンドを実行して最初の仮想ネットワークを作成し、アップロードしたテンプレートとパラメーター ファイルを使用して仮想マシンのペアをデプロイします。

   ```pwsh
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-06-vms-template.json `
      -TemplateParameterFile $HOME/az104-06-vm-parameters.json `
      -AsJob
   ```

1. [Cloud Shell] ペインから次を実行して、次のコマンドを実行して、2 番目の仮想ネットワークと 3 番目の仮想マシンをホストする 2 番目のリソース グループを作成します。

   ```pwsh
   $rgName = 'az104-06-rg2'

   New-AzResourceGroup -Name $rgName -Location $location
   ```
1. [Cloud Shell] ウィンドウで、次のコマンドを実行して 2 つ目の仮想ネットワークを作成し、アップロードしたテンプレートとパラメーター ファイルを使用して仮想マシンをデプロイします。

   ```pwsh
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-06-vm-template.json `
      -TemplateParameterFile $HOME/az104-06-vm-parameters.json `
      -nameSuffix 2 `
      -AsJob
   ```
1. [Cloud Shell] ペインから次のコマンドを実行して、3 番目の仮想ネットワークと 4 番目の仮想マシンをホストする3番目のリソース グループを作成します。

   ```pwsh
   $rgName = 'az104-06-rg3'

   New-AzResourceGroup -Name $rgName -Location $location
   ```
1. [Cloud Shell] ペインで、次のコマンドを実行して 3 つ目の仮想ネットワークを作成し、アップロードしたテンプレートとパラメーター ファイルを使用して仮想マシンをデプロイします。

   ```pwsh
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-06-vm-template.json `
      -TemplateParameterFile $HOME/az104-06-vm-parameters.json `
      -nameSuffix 3 `
      -AsJob
   ```
    >**Note**: 次のタスクを進める前に、スクリプトが完了するのを待ちます。これには約 5 分間かかります。

    >**注**: デプロイの状態を確認するには、このタスクで作成したリソース グループのプロパティを調べます。

1. [Cloud Shell] パネルを閉じます。

#### タスク 2: ハブ スポーク ネットワーク トポロジを構成する

このタスクでは、前のタスクで展開した仮想ネットワーク間のローカル ピアリングを構成して、ハブ アンド スポーク ネットワーク トポロジを作成します。

1. Azure ポータルで、 [**仮想ネットワーク**]を検索して選択します。 

1. 前のタスクで作成した仮想ネットワークをレビューします。 

    >**注**: 3 つの仮想ネットワークのデプロイに使用したテンプレートにより、3 つの仮想ネットワークの IP アドレス範囲が重複しないようにします。

1. 仮想ネットワークの一覧で、**az104-06-vnet01**をクリックします。 

1. **[az104-06-vnet01** 仮想ネットワーク] ブレードの **[設定]** セクションで、[**ピアリング**] をクリックし、[**+ 追加**] をクリック します。       

1. 次の設定でピアリングを追加します (他のユーザーには既定値を残します)。

    | 設定 | 値 |
    | --- | --- |
    | az104-06-vnet01 からリモート仮想ネットワークへのピアリングの名前 | **az104-06-vnet01_to_az104-06-vnet2** |
    | 仮想ネットワーク デプロイ モデル | **Resource Manager** |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | Virtual Network | **az104-06-vnet2 (az104-06-rg2)** |
    | az104-06-vnet2 から az104-06-vnet01 へのピアリングの名前 | **az104-06-vnet2_to_az104-06-vnet01** |
    | az104-06-vnet01 から az104-06-vnet2 への仮想ネットワーク アクセスを許可する | **Enabled** |
    | az104-06-vnet2 から az104-06-vnet01 への仮想ネットワーク アクセスを許可する | **Enabled** |
    | az104-06-vnet2 から az104-06-vnet01 への転送トラフィックを許可する | **Enabled** |
    | az104-06-vnet01 から az104-06-vnet2 への転送トラフィックを許可する | **Enabled** |
    | Allow gateway transit（ゲートウェイ トランジットの許可） | **(チェックボックスをオフにする)** |

    >**注**: 操作が完了するまで待ちます。

    >**注**: このステップでは、az104-06-vnet01 から az104-06-vnet2、az104-06-vnet2 から az104-06-vnet01 までの 2 つのローカル ピアリングを確立します。

    >**注**: このラボで後ほど実装するスポーク仮想ネットワーク間のルーティングを容易にするために、**転送トラフィックを許可する**必要があります。

1. **[az104-06-vnet01** 仮想ネットワーク] ブレードの **[設定]** セクションで、[**ピアリング**] をクリックし、[**+ 追加**] をクリック します。       

1. 次の設定でピアリングを追加します (他のユーザーには既定値を残します)。

    | 設定 | 値 |
    | --- | --- |
    | az104-06-vnet01 からリモート仮想ネットワークへのピアリングの名前 | **az104-06-vnet01_to_az104-06-vnet3** |
    | 仮想ネットワーク デプロイ モデル | **Resource Manager** |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | 仮想ネットワーク | **az104-06-vnet3 (az104-06-rg3)** |
    | az104-06-vnet3 から az104-06-vnet01 へのピアリングの名前 | **az104-06-vnet3_to_az104-06-vnet01** |
    | az104-06-vnet01 から az104-06-vnet3 への仮想ネットワーク アクセスを許可する | **Enabled** |
    | az104-06-vnet3 から az104-06-vnet01 への仮想ネットワーク アクセスを許可する | **Enabled** |
    | az104-06-vnet3 から az104-06-vnet01 への転送トラフィックを許可する | **Enabled** |
    | az104-06-vnet01 から az104-06-vnet3 への転送トラフィックを許可する | **Enabled** |
    | Allow gateway transit（ゲートウェイトランジットの許可） | **(チェックボックスをオフにする)** |

    >**注**: このステップでは、az104-06-vnet01 から az104-06-vnet3、az104-06-vnet3 から az104-06-vnet01 までの 2 つのローカル ピアリングを確立します。これで、ハブとスポーク トポロジの設定が完了します (2 つのスポーク仮想ネットワークを使用)。

    >**注**: このラボで後ほど実装するスポーク仮想ネットワーク間のルーティングを容易にするために、**転送トラフィックを許可する**必要があります。

#### タスク 3: 仮想ネットワーク ピアリングの推移性をテストする

このタスクでは、ネットワーク監視を使用して仮想ネットワーク ピアリングの推移性をテストします。

1. Azure portal で、[**ネットワーク監視**] を検索して選択します。 

1. [**ネットワーク ウォッチャー**] ブレードで、Azure リージョンの一覧を展開し、このラボの最初のタスクでリソースをデプロイした Azure でサービスが有効になっていることを確認します。 

1. [**ネットワーク 監視**] ブレードで、[**接続のトラブルシューティング**] に移動します。   

1. [**ネットワーク監視 - 接続のトラブルシューティング**] ブレードで、次の設定でチェックを開始します (既定値のままにします)。 

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | Resource group | **az104-06-rg1** |
    | ソース タイプ | **仮想マシン** |
    | 仮想マシン | **az104-06-vm0** |
    | 目的地 | **手動で指定する** |
    | URI、FQDN または IPv4 | **10.62.0.4** |
    | プロトコル | **TCP** |
    | 宛先ポート | **3389** |

    > **注意**: **10.62.0.4** は、プライベート IP アドレス **az104-06-vm2**を表します。

1. **[確認]** をクリック し、接続チェックの結果が返されるまで待ちます。 状態が **到達可能** であることを確認します。ネットワーク パスを確認し、VM 間に中間ホップのない直接接続であったことに注意します。

    > **注意**: ハブ仮想ネットワークは最初のスポーク仮想ネットワークと直接ピアリングされるため、これは予期されます。

    > **注意**: 最初のチェックでは、**az104-06-vm0**にネットワーク 監視エージェント仮想マシン拡張をインストールする必要があるため、約 2 分かかることがあります。

1. [**ネットワーク監視 - 接続のトラブルシューティング**] ブレードで、次の設定でチェックを開始します (既定値のままにします)。 

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | Resource group | **az104-06-rg1** |
    | ソース タイプ | **仮想マシン** |
    | 仮想マシン | **az104-06-vm0** |
    | 目的地 | **手動で指定する** |
    | URI、FQDN または IPv4 | **10.63.0.4** |
    | プロトコル | **TCP** |
    | 宛先ポート | **3389** |

    > **注意**: **10.63.0.4** は、プライベート IP アドレス **az104-06-vm3**を表します。

1. **[確認]**をクリック し、接続チェックの結果が返されるまで待ちます。 状態が **到達可能**であることを確認します。ネットワーク パスを確認し、VM 間に中間ホップのない直接接続であったことに注意します。

    > **注意**: ハブ仮想ネットワークは 2 番目のスポーク仮想ネットワークと直接ピアリングされるため、これは予期されます。

1. [**ネットワーク監視 - 接続のトラブルシューティング**] ブレードで、次の設定でチェックを開始します (既定値のままにします)。 

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | Resource group | **az104-06-rg2** |
    | ソース タイプ | **仮想マシン** |
    | 仮想マシン | **az104-06-vm2** |
    | 目的地 | **手動で指定する** |
    | URI、FQDN または IPv4 | **10.63.0.4** |
    | プロトコル | **TCP** |
    | 宛先ポート | **3389** |

1. **[確認]** をクリック し、接続チェックの結果が返されるまで待ちます。 ステータスが [**到達不能**] であることに注意してください。  

    > **注意**: これは、2 つのスポーク仮想ネットワークが互いにピアリングされないので、予想されます (仮想ネットワーク ピアリングは推移的ではありません)。

#### タスク 4: ハブとスポーク トポロジでルーティングを構成する

このタスクでは、 **az104-06-vm0**仮想マシンのネットワーク インターフェイスで IP 転送を有効にし、オペレーティング システム内でルーティングを有効にし、スポーク仮想ネットワーク上でユーザー定義のルートを構成することにより、2 つのスポーク仮想ネットワーク間のルーティングを構成およびテストします。 

1. Azure portal で、**仮想マシン**を検索して選択します。

1. [**仮想マシン**] ブレードの仮想マシンの一覧で、**[az104-06-vm0]** をクリックします。   

1. **[az104-06-vm0** 仮想マシン] ブレードの **[設定]** セクションで、**[ネットワーク]** をクリック します。     

1. [**ネットワーク インターフェイス**]ラベルの横にある **az104-06-nic0** リンクをクリックし 、**az104-06-nic0** ネットワークインターフェイス ブレードの [**設定**] セクションで、 [**IP 構成**] をクリックします。            

1. **[IP 転送]** を **[Enabled]** に設定し、変更を保存します。    

   > **注意**: この設定は、2つのスポーク仮想ネットワーク間でトラフィックをルーティングするルータとして **az104-06-vm0** が機能するために必要です。

   > **注意**: ここで、ルーティングをサポートするように **az104-06-vm0**仮想マシンのオペレーティング システムを構成する必要があります。

1. Azure portal で、[**az104-06-vm0のAzure 仮想マシン**] ブレードに戻り 、 [**概要**] をクリックします。 

1. [**az104-06-vm0**] ブレードの [操作] セクションで [**コマンドの実行**] をクリックし、コマンドの一覧で[**RunPowerShellScript**] をクリックします。       

1. [**コマンド スクリプトの実行**] ブレードで、次のコマンドを入力し、[**実行**] をクリックして Remote Access Windows Server をインストールします。   

   ```pwsh
   Install-WindowsFeature RemoteAccess -IncludeManagementTools
   ```

   > **注意**: コマンドが正常に完了したことを確認します。

1. [**コマンド スクリプトの実行**] ブレードで 、次のコマンドを入力し、 [**実行**] をクリックしてルーティング ロール サービスをインストールします。   

   ```pwsh
   Install-WindowsFeature -Name Routing -IncludeManagementTools -IncludeAllSubFeature

   Install-WindowsFeature -Name "RSAT-RemoteAccess-Powershell"

   Install-RemoteAccess -VpnType RoutingOnly

   Get-NetAdapter | Set-NetIPInterface -Forwarding Enabled
   ```

   > **注意**: コマンドが正常に完了したことを確認します。

   > **注意**: 次に、スポーク仮想ネットワーク上でユーザー定義のルートを作成および構成する必要があります。

1. Azure portal で [**ルート テーブル**]を検索して選択 し、[**ルート テーブル**] ブレードで [**+ 追加**] をクリックします。    

1. 次の設定でルート テーブルを作成します (既定値を他のユーザーのままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **az104-06-rt23** |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | Resource group | **az104-06-rg2** |
    | 場所 | 仮想ネットワークを作成したのと同じ Azure リージョンの名前 |
    | 仮想ネットワーク ゲートウェイ ルートの伝播 | **Disabled** |

   > **注意**：新しいルーティング テーブルが作成されるのを待ちます。これには約 3 分かかります。

1. **[ルート テーブル]** ブレードに戻り、**[更新]** をクリックし、**[az104-06-rt23]** をクリックします。     

1. **[az104-06-rt23]** ルート テーブル ブレードで、**[ルート]** をクリックし、**[+ 追加]** をクリック します。     

1. 次の設定で新しいルートを追加します。その他の設定は既定値のままにします。

    | 設定 | 値 |
    | --- | --- |
    | ルート名 | **az104-06-route-vnet2-to-vnet3** |
    | アドレス プレフィックス | **10.63.0.0/20** |
    | ネクスト ホップのタイプ | **仮想アプライアンス** |
    | ネクスト ホップのアドレス | **10.60.0.4** |

1. [**az104-06-rt23** ルート テーブル] ブレードに戻って [**サブネット**] をクリックし、[**+ 関連付け**] をクリックします。

1. ルート テーブル [**az104-06-rt23**] を次のサブネットに関連付けます。

    | 設定 | 値 |
    | --- | --- |
    | 仮想ネットワーク | **az104-06-vnet2** |
    | サブネット | **subnet0** |

1. [**ルート テーブル**] ブレードに戻り、[**+ 追加**] をクリックします。

1. 次の設定でルート テーブルを作成します (既定値を他のユーザーのままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **az104-06-rt32** |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | **az104-06-rg3** |
    | 場所 | 仮想ネットワークを作成したのと同じ Azure リージョンの名前 |
    | 仮想ネットワーク ゲートウェイ ルートの伝播 | **Disabled** |

   > **注意**: 新しいルーティング テーブルが作成されるのを待ちます。これには約 3 分かかります。

1. [**ルート テーブル**] ブレードに戻って [**更新**] をクリックし、[**az104-06-rt32**] をクリックします。

1. [**az104-06-rt32** ルート テーブル] ブレードで [**ルート**] をクリックし、[**+ 追加**] をクリックします。

1. 次の設定で新しいルートを追加します。その他の設定は既定値のままにします。

    | 設定 | 値 |
    | --- | --- |
    | ルート名 | **az104-06-route-vnet3-to-vnet2** |
    | アドレス プレフィックス | **10.62.0.0/20** |
    | ネクスト ホップのタイプ | **仮想アプライアンス** |
    | ネクスト ホップのアドレス | **10.60.0.4** |

1. [**az104-06-rt32** ルート テーブル] ブレードに戻って [**サブネット**] をクリックし、[**+ 関連付け**] をクリックします。

1. ルート テーブル [**az104-06-rt32**] を次のサブネットに関連付けます。

    | 設定 | 値 |
    | --- | --- |
    | 仮想ネットワーク | **az104-06-vnet3** |
    | サブネット | **subnet0** |

1. Azure portal で、[**Network Watcher - 接続トラブルシューティング**] ブレードに戻ります。

1. [**ネットワーク監視 - 接続のトラブルシューティング**] ブレードで、次の設定でチェックを開始します (既定値のままにします)。 

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | **az104-06-rg2** |
    | ソース タイプ | **仮想マシン** |
    | 仮想マシン | **az104-06-vm2** |
    | 目的地 | **手動で指定する** |
    | URI、FQDN または IPv4 | **10.63.0.4** |
    | プロトコル | **TCP** |
    | 宛先ポート | **3389** |

1. **[確認]** をクリック し、接続チェックの結果が返されるまで待ちます。  状態が **到達可能**であることを確認します。ネットワーク パスを確認し、トラフィックが **az104-06-nic0** ネットワーク アダプターに割り当てられた **10.60.0.4** を経由してルーティングされたことを確認します。

    > **注意**: これは想定どおりの結果です。スポーク仮想ネットワーク間のトラフィックは、ルーターとして機能するハブ仮想ネットワークにある仮想マシンを経由してルーティングされるためです。 

    > **注意**: **Network Watcher** を使用して、ネットワークのトポロジを表示できます。

#### タスク 5: Azure Load Balancer を実装する

このタスクでは、ハブ仮想ネットワーク内の 2 つの Azure 仮想マシンの前に Azure Load Balancer を実装します。

1. Azure portal で [**負荷分散装置**] を検索して選択し、[**負荷分散装置**] ブレードで [**+ 追加**] をクリックします。

1. 次の設定で負荷分散装置を作成します。その他の設定は既定値のままにします。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | 新しいリソース グループ **az104-06-rg4** の名前 |
    | 名前 | **az104-06-lb4** |
    | リージョン| このラボでその他のすべてのリソースをデプロイした Azure リージョンの名前 |
    | タイプ | **公開** |
    | SKU | **Standard** |
    | パブリック IP アドレス | **新規作成** |
    | パブリック IP アドレス名 | **az104-06-pip4** |
    | 可用性ゾーン | **ゾーン冗長** |
    | パブリック IPv6 アドレスを追加する | **No** |

    > **注意**: Azure Load Balancer がプロビジョニングされるのを待ちます。これには約 2 分かかります。 

1. デプロイ ブレードで、[**Go to resource**] (リソースに移動) をクリックします。

1. **az104-06-lb4** ロード バランサー ブレードで、[**バックエンド プール**] をクリックし、[**+ 追加**] をクリックします。     

1. 次の設定でバックエンド プールを追加します (その他は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **az104-06-lb4-be1** |
    | 仮想ネットワーク | **az104-06-vnet01** |
    | IP バージョン:  | **IPv4** |
    | 仮想マシン | **az104-06-vm0** | 
    | 仮想マシンの IP アドレス | **ipconfig1 (10.60.0.4)** |
    | 仮想マシン | **az104-06-vm1** |
    | 仮想マシンの IP アドレス | **ipconfig1 (10.60.1.4)** |

1. バックエンド プールが作成されるのを待ち、[**正常性プローブ**] をクリックして、[**+ 追加**] をクリック します。   

1. 次の設定で正常性プローブを追加します (その他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **az104-06-lb4-hp1** |
    | プロトコル | **TCP** |
    | ポート | **80** |
    | 間隔 | **5** |
    | 異常なしきい値 | **2** |

1. 正常性プローブが作成されるのを待ち、 [**負荷分散規則**] をクリックして、**[+ 追加]** クリックします。   

1. 次の設定で負荷分散規則を追加します (その他は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **az104-06-lb4-lbrule1** |
    | IP バージョン:  | **IPv4** |
    | プロトコル | **TCP** |
    | ポート | **80** |
    | バックエンド ポート | **80** |
    | バックエンド プール | **az104-06-lb4-be1** |
    | 正常性プローブ | **az104-06-lb4-hp1** |
    | セッション永続化 | **なし** |
    | アイドル タイムアウト (分) | **4 年** |
    | TCP リセット | **Disabled** |
    | フローティングIP（直接サーバーリターン） | **Disabled** |
    | 暗黙的な送信ルールの作成 | **Yes** |

1. 負荷分散規則が作成されるのを待ち、 [**概要**] をクリックして、 **パブリック IP アドレス**の値を記録します。   

1. 他のブラウザーのウインドウを起動し、前のステップに識別した IP アドレスに移動します。

1. ブラウザー ウィンドウに、**az104-06-vm0 から Hello World** または **az104-06-vm1 から Hello World** というメッセージが表示されることを確認します。

1. 別のブラウザー ウィンドウを開きますが、今回は InPrivate モードを使用して、ターゲット VM が (メッセージで示されているように) 変更するかどうかを確認します。 

    > **注意**: ブラウザー ウィンドウを更新するか、InPrivate モードを使用して再度開く必要があります。

#### タスク 6: Azure Application Gateway を実装する

このタスクでは、スポーク仮想ネットワーク内の 2 つの Azure 仮想マシンの前に Azure Application Gateway を実装します。

1. Azure portal で、[**仮想ネットワーク**] を検索して選択します。

1. 仮想ネットワークの一覧の中の[**仮想ネットワーク**] ブレードで、[**az104-06-vnet01**] をクリックします。

1. **Az104-06-vnet01** 仮想ネットワーク ブレードの**設定**セクションで、**サブネット**をクリックしてから **+ Subnet** (+ サブネットの追加) をクリックします。

1. 次の設定でサブネットを追加します。その他の設定は既定値のままにします。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **subnet-appgw** |
    | アドレス範囲 (CIDR ブロック) | **10.60.3.224/27** |
    | ネットワーク セキュリティ グループ | **なし** |
    | ルート テーブル | **なし** |

    > **注意**: このサブネットは、このタスクの後半でデプロイする Azure Application Gateway インスタンスで使用されます。Application Gateway には、/27 以上のサイズの専用サブネットが必要です。

1. Azure portal で**アプリケーション ゲートウェイ**を検索して選択し、[**アプリケーション ゲートウェイ**] ブレードで [**+ 追加**] をクリック します。     

1. [**アプリケーション ゲートウェイの作成**] ブレードの [**基本**] タブで、次の設定を指定します (その他は既定値のままにします)。   

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | 新しいリソース グループ **az104-06-rg5** の名前 |
    | アプリケーション ゲートウェイ名 | **az104-06-appgw5** |
    | リージョン | このラボでその他のすべてのリソースをデプロイした Azure リージョンの名前 |
    | 階層 | **Standard V2** |
    | 自動スケーリングを有効にする | **No** |
    | スケール ユニット | **1** |
    | 可用性ゾーン | **1, 2, 3** |
    | HTTP2 | **Disabled** |
    | 仮想ネットワーク | **az104-06-vnet01** |
    | サブネット | **subnet-appgw** |

1. [**次へ:**] をクリックする**フロントエンド >**] をクリックし、[**アプリケーション ゲートウェイの作成**] ブレードの [**フロントエンド**] タブで、次の設定を指定します。その他の設定は既定値のままにします。

    | 設定 | 値 |
    | --- | --- |
    | フロントエンド IP アドレス タイプ | **公開** |
    | ファイアウォール パブリック IP アドレス | 新しいパブリック IP アドレス **az104-06-pip5** |

1. **次へ:バックエンド>** をクリックします。バックエンド ** **Create an application gateway** (アプリケーション ゲートウェイの作成) の **バックエンド** タブで、**Add a backend pool** (バックエンド プールの追加) をクリックして、**Add a backend pool** (バックエンド プールの追加) ブレードで次の設定を指定します (その他の値は既定値のまま)。        

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **az104-06-appgw5-be1** |
    | ターゲットを使用せずにバックエンド プールを追加する | **No** |
    | ターゲット タイプ | **IP アドレスまたは FQDN** |
    | ターゲット | **10.62.0.4** |
    | ターゲット タイプ | **IP アドレスまたは FQDN** |
    | ターゲット | **10.63.0.4** |

    > **注意**: ターゲットは、スポーク仮想ネットワーク **az104-06-vm2** および **az104-06-vm3** 内の仮想マシンのプライベート IP アドレスを表します。

1. **追加**、**次へ:構成 >** の順にクリックします。構成 **Create an application gateway** (アプリケーション ゲートウェイの作成) ブレードの**構成**タブで、**+ Add a routing rule** (+ ルーティング ルールの追加) をクリックします  

1. [**ルーティングルールの追加**] ブレードの [**リスナー**] タブで、次の設定を指定します。その他の設定は既定値のままにします。

    | 設定 | 値 |
    | --- | --- |
    | ルール名 | **az104-06-appgw5-rl1** |
    | リスナー名 | **az104-06-appgw5-rl1l1** |
    | フロントエンド IP | **公開** |
    | プロトコル | **HTTP** |
    | ポート | **80** |
    | リスナーの種類 | **Basic** |
    | エラー ページ URL | **No** |

1. [**ルーティング ルールの追加**] ブレードの [**バックエンド ターゲット**] タブに切り替え、次の設定を指定します (その他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | ターゲット タイプ | **バックエンド プール** |
    | バックエンド ターゲット | **az104-06-appgw5-be1** |

1. **[ルーティング ルールの追加]** ブレードの **[バックエンド ターゲット]** タブで 、**[HTTP 設定]** テキスト ボックスの横にある **[新規作成]** をクリックし、**[HTTP 設定の追加]** ブレードで、次の設定を指定します (その他は既定値のままにします)。         

    | 設定 | 値 |
    | --- | --- |
    | HTTP 設定名 | **az104-06-appgw5-http1** |
    | バックエンド プロトコル | **HTTP** |
    | バックエンド ポート | **80** |
    | Cookie ベースのアフィニティ | **Disable** |
    | 接続ドレイン | **Disable** |
    | 要求タイムアウト (秒) | **20** |

1. [**HTTP 設定の追加**] ブレードで [**追加**] をクリックし、[**ルーティング ルールの追加**] ブレードに戻って [**追加**] をクリックします。

1. [**Next: Tags >**] をクリックし、続いて [**Next: Review + create >**] をクリックし、[**作成**] をクリックします。

    > **注意**: Application Gateway インスタンスが作成されるのを待ちます。これには最大で 8 分ほどかかる場合があります。

1. Azure portal で [**Application Gateways**] を検索して選択し、[**Application Gateways**] ブレードで [**az104-06-appgw5**] をクリックします。

1. [**az104-06-appgw5** Application Gateway] ブレードで、**フロントエンド パブリック IP アドレス**の値を書き留めます。

1. 他のブラウザーのウインドウを起動し、前のステップに識別した IP アドレスに移動します。

1. ブラウザー ウィンドウに "**Hello World from az104-06-vm2**" または "**Hello World from az104-06-vm3**" というメッセージが表示されることを確認します。

1. 今度は InPrivate モードを使用して別のブラウザー ウィンドウを開き、Web ページに表示されるメッセージに基づいて、ターゲット VM が変更されたかどうかを確認します。 

    > **注意**: ブラウザー ウィンドウを更新するか、InPrivate モードを使用して再度開く必要があります。

    > **注意**: 複数の仮想ネットワーク上の仮想マシンを対象とすることは一般的な構成ではありませんが、Application Gateway が複数の仮想ネットワーク上の仮想マシンや、他の Azureリージョンのエンドポイント、さらには Azure の外部のエンドポイントを対象とできる点を示すことを目的としています。同じ仮想ネットワーク内の仮想マシン間で負荷分散を行う Azure Load Balancer とは異なります。

#### リソースのクリーンアップ

   >**注**: 新しく作成した Azure リソースのうち、使用しないリソースは必ず削除してください。使用していないリソースを削除することで、予期しないコストが発生しなくなります。

1. Azure portalの [**Cloud Shell**] ウインドウで、[**PowerShell**] セッションを開始します。

1. 次のコマンドを実行して、このモジュールのラボ全体で作成されたすべてのリソース グループを一覧表示します。

   ```pwsh
   Get-AzResourceGroup -Name 'az104-06*'
   ```

1. 次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループを削除します。

   ```pwsh
   Get-AzResourceGroup -Name 'az104-06*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**注**: コマンドは非同期に実行されるため (-AsJob パラメーターによって決まります)、同じ PowerShell セッション内ですぐに別の PowerShell コマンドを実行できますが、リソース グループが実際に削除されるまでに数分かかります。

#### レビュー

このラボでは、次の内容を学習しました。

- ラボ環境の構成
- ハブ と スポーク ネットワーク トポロジの構成
- 仮想ネットワーク ピアリングの推移性のテスト
+ ハブとスポーク トポロジでのルーティングの構成
+ Azure Load Balancer の実装
+ Azure Application Gateway の実装
